##
##  Makefile to build MiniSat as a static library: libminisat.a
##  Object files go to ../build
##  Library goes to ../clib
##

# ---------------------------------------------------------------------
# Directories
# ---------------------------------------------------------------------
BUILD_DIR = ../build
LIB_DIR   = ../clib

# ---------------------------------------------------------------------
# Sources & Objects
# ---------------------------------------------------------------------
CSRCS     = $(wildcard *.C)
CHDRS     = $(wildcard *.h)

# Base object names (File.o, Solver.o, etc.)
BASEOBJS  = $(addsuffix .o, $(basename $(CSRCS)))

# Object locations per configuration
COBJS     = $(addprefix $(BUILD_DIR)/, $(BASEOBJS))
PCOBJS    = $(addprefix $(BUILD_DIR)/, $(addsuffix p, $(BASEOBJS)))
DCOBJS    = $(addprefix $(BUILD_DIR)/, $(addsuffix d, $(BASEOBJS)))
RCOBJS    = $(addprefix $(BUILD_DIR)/, $(addsuffix r, $(BASEOBJS)))

LIB       = libminisat.a

# ---------------------------------------------------------------------
# Compiler
# ---------------------------------------------------------------------
CXX       = g++
CFLAGS    = -Wall -ffloat-store -std=gnu++98
COPTIMIZE = -O3

# ---------------------------------------------------------------------
# Build modes
# ---------------------------------------------------------------------
.PHONY : s p d r rs build clean depend

s:  WAY=standard
p:  WAY=profile
d:  WAY=debug
r:  WAY=release
rs: WAY=release-static

s:  CFLAGS += $(COPTIMIZE) -ggdb -D DEBUG
p:  CFLAGS += $(COPTIMIZE) -pg -ggdb -D DEBUG
d:  CFLAGS += -O0 -ggdb -D DEBUG
r:  CFLAGS += $(COPTIMIZE) -D NDEBUG
rs: CFLAGS += $(COPTIMIZE) -D NDEBUG

s:  build $(LIB_DIR)/$(LIB)
p:  build $(LIB_DIR)/$(LIB)
d:  build $(LIB_DIR)/$(LIB)
r:  build $(LIB_DIR)/$(LIB)
rs: build $(LIB_DIR)/$(LIB)

# ---------------------------------------------------------------------
# Directory creation
# ---------------------------------------------------------------------
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

$(LIB_DIR):
	@mkdir -p $(LIB_DIR)

# ---------------------------------------------------------------------
# Banner
# ---------------------------------------------------------------------
build:
	@echo Building MiniSat "("$(WAY)")"

# ---------------------------------------------------------------------
# Compilation rule
# ---------------------------------------------------------------------
# Example output: ../build/File.o, ../build/File.op, etc.
$(BUILD_DIR)/%.o $(BUILD_DIR)/%.op $(BUILD_DIR)/%.od $(BUILD_DIR)/%.or: %.C | $(BUILD_DIR)
	@echo Compiling: $<
	@$(CXX) $(CFLAGS) -c -o $@ $<

# ---------------------------------------------------------------------
# Create static library
# ---------------------------------------------------------------------
$(LIB_DIR)/$(LIB): $(COBJS) | $(LIB_DIR)
	@echo Creating static library $@
	@ar rcs $@ $(COBJS)

# ---------------------------------------------------------------------
# Clean
# ---------------------------------------------------------------------
clean:
	@rm -f $(BUILD_DIR)/*.o $(BUILD_DIR)/*.op $(BUILD_DIR)/*.od $(BUILD_DIR)/*.or
	@rm -f $(LIB_DIR)/$(LIB)
	@rm -f depend.mak

# ---------------------------------------------------------------------
# Dependency generation
# ---------------------------------------------------------------------
depend: depend.mak

depend.mak: $(CSRCS) $(CHDRS)
	@echo Making dependencies ...
	@$(CXX) -MM $(CSRCS) > depend.mak
	@cp depend.mak /tmp/depend.tmp
	@sed "s/o:/op:/" /tmp/depend.tmp >> depend.mak
	@sed "s/o:/od:/" /tmp/depend.tmp >> depend.mak
	@sed "s/o:/or:/" /tmp/depend.tmp >> depend.mak
	@rm /tmp/depend.tmp

include depend.mak
